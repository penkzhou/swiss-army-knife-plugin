# Multi-stack bugfix workflow 默认配置
# 项目可通过 .claude/swiss-army-knife.yaml 覆盖
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ 运行时验证建议 (RUNTIME VALIDATION RECOMMENDATIONS)                          │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ 本配置文件定义了多个不变式和约束，建议在使用时进行以下验证：                  │
# │                                                                              │
# │ 1. 权重验证：                                                                │
# │    - confidence_factors 权重之和必须等于 1.0                                 │
# │    - 验证：sum(factors.values()) == 1.0                                     │
# │    - 失败处理：警告并归一化权重                                              │
# │                                                                              │
# │ 2. 阈值排序验证：                                                            │
# │    - confidence_threshold 必须满足降序排列                                   │
# │    - 验证：auto_fix > ask_user > need_clarification/suggest_manual          │
# │    - 失败处理：拒绝加载并报错                                                │
# │                                                                              │
# │ 3. 日志上下文验证：                                                          │
# │    - logging 对象传递到 coordinator 链时应验证必需字段                       │
# │    - 必需字段：enabled, level, session_id                                   │
# │    - 失败处理：使用默认值 + 发出警告（不能静默）                              │
# │    - 警告格式：`⚠️ 配置警告：logging.{field} 无效，使用默认值 {default}`     │
# │                                                                              │
# │ 4. Bash 脚本验证（开发阶段）：                                               │
# │    - commands/*.md 中的 bash 代码块建议通过 shellcheck 验证                  │
# │    - 验证：shellcheck <(extract_bash_blocks file.md)                        │
# │    - CI 集成：可添加 pre-commit hook 自动验证                                │
# │                                                                              │
# │ 注意：由于这是一个纯 Markdown/YAML 配置项目，没有传统的单元测试框架。         │
# │ 上述验证应在 agent 加载配置时实现，或通过 lint 工具在 CI 中检查。            │
# │                                                                              │
# │ 5. 配置回退警告（重要）：                                                    │
# │    - 当配置验证失败使用默认值时，必须发出警告，禁止静默回退                    │
# │    - 警告输出到 stderr，确保用户能看到                                       │
# │    - 如果启用日志，同时写入日志文件                                          │
# │    - 示例实现：                                                              │
# │      ```python                                                               │
# │      def validate_with_warning(field, value, default, validator):            │
# │          if not validator(value):                                            │
# │              print(f"⚠️ 配置警告：{field} 值 '{value}' 无效，"               │
# │                    f"使用默认值 '{default}'", file=sys.stderr)               │
# │              if log_ctx.enabled:                                             │
# │                  log_warning("CONFIG_FALLBACK", f"{field}={value}→{default}")│
# │              return default                                                  │
# │          return value                                                        │
# │      ```                                                                     │
# └─────────────────────────────────────────────────────────────────────────────┘

# 共享文档路径配置（各技术栈可覆盖）
defaults:
  docs:
    bugfix_dir: "docs/bugfix"
    best_practices_dir: "docs/best-practices"

# 过程日志配置
# 通过 --log 或 --verbose 命令行选项启用
logging:
  # 是否默认启用日志（可被 --log 命令行选项覆盖）
  enabled: false

  # 默认日志级别（可被 --verbose 覆盖为 debug）
  # info: 记录 Phase/Agent 事件、置信度决策、用户交互
  # debug: 额外记录完整的 agent 输入输出（文件可能较大）
  level: "info"

  # 日志输出目录（相对于项目根目录）
  output_dir: ".claude/logs/swiss-army-knife"

  # 输出格式配置
  formats:
    jsonl: true   # JSON Lines 格式，便于 jq 查询
    text: true    # 人类可读的文本格式

  # 日志保留天数（0 = 永久保留）
  retention_days: 30

  # DEBUG 级别时是否包含完整的 agent 输入输出
  # 警告：启用后日志文件可能非常大
  include_agent_io: true

# Bugfix 工作流置信度配置（根因分析阶段）
# ┌─────────────────────────────────────────────────────────────────┐
# │ 不变式 (INVARIANT): auto_continue > ask_user > stop            │
# │ 当前: 60 > 40 > 0 ✓                                            │
# │                                                                  │
# │ 阈值定义的是下界（含），决策逻辑：                               │
# │   confidence >= 60 → auto_continue (自动继续)                   │
# │   confidence >= 40 → ask_user (询问用户)                        │
# │   confidence < 40  → stop (停止执行)                            │
# │                                                                  │
# │ 注意：此阈值用于 Phase 1 根因分析，与 Review 阶段阈值(80)不同   │
# │ 诊断允许较低阈值是因为根因分析本身存在不确定性                   │
# └─────────────────────────────────────────────────────────────────┘
bugfix:
  confidence_threshold:
    auto_continue: 60   # >= 60 自动继续到 Phase 2
    ask_user: 40        # 40-59 询问用户是否继续
    # < 40 停止执行，返回失败

stacks:
  frontend:
    name: "Frontend (React/TypeScript)"
    test_command: "make test TARGET=frontend"
    lint_command: "make lint TARGET=frontend"
    typecheck_command: "make typecheck TARGET=frontend"
    # docs 继承自 defaults.docs
    search_keywords:
      mock: ["mock", "msw", "vi.mock", "server.use", "HttpResponse"]
      async: ["async", "await", "findBy", "waitFor", "act"]
      type: ["typescript", "type", "interface", "as any", "generic"]
      render: ["render", "screen", "component", "props"]
      hook: ["useEffect", "useMemo", "useCallback", "useState"]
    error_patterns:
      mock_conflict:
        frequency: 71
        signals: ["vi.mock", "server.use"]
        description: "Mock 层次冲突（Hook Mock vs HTTP Mock）"
      type_mismatch:
        frequency: 15
        signals: ["as any", "type error", "Property.*does not exist"]
        description: "TypeScript 类型不匹配"
      async_timing:
        frequency: 8
        signals: ["findBy", "await", "act\\("]
        description: "异步操作时序问题"
      render_issue:
        frequency: 4
        signals: ["render", "screen", "not wrapped in act"]
        description: "组件渲染问题"
      cache_dependency:
        frequency: 2
        signals: ["useEffect", "useMemo", "dependency"]
        description: "Hook 缓存依赖问题"

  backend:
    name: "Backend (Python/FastAPI)"
    test_command: "make test TARGET=backend"
    lint_command: "make lint TARGET=backend"
    typecheck_command: "make typecheck TARGET=backend"
    # docs 继承自 defaults.docs
    search_keywords:
      database: ["database", "query", "ORM", "SQL", "transaction", "SQLAlchemy"]
      api: ["endpoint", "request", "response", "REST", "GraphQL", "FastAPI"]
      auth: ["authentication", "authorization", "token", "JWT", "session"]
      validation: ["validation", "schema", "pydantic", "input", "sanitize"]
      async: ["async", "await", "asyncio", "concurrent"]
    error_patterns:
      database_error:
        frequency: 30
        signals: ["IntegrityError", "OperationalError", "sqlalchemy.exc", "UNIQUE constraint"]
        description: "数据库连接、查询、事务问题"
      validation_error:
        frequency: 25
        signals: ["ValidationError", "pydantic", "422 Unprocessable", "field required"]
        description: "输入验证、Schema 验证失败"
      api_error:
        frequency: 20
        signals: ["HTTPException", "status_code", "404 Not Found", "405 Method Not Allowed"]
        description: "API 端点错误、HTTP 状态码问题"
      auth_error:
        frequency: 10
        signals: ["401 Unauthorized", "403 Forbidden", "token", "credentials"]
        description: "认证授权失败、Token 问题"
      async_error:
        frequency: 8
        signals: ["TimeoutError", "CancelledError", "asyncio", "await"]
        description: "异步操作、并发问题"
      config_error:
        frequency: 5
        signals: ["KeyError", "environment", "settings", "config"]
        description: "配置加载、环境变量问题"

  e2e:
    name: "E2E (Playwright/Cypress)"
    test_command: "make test TARGET=e2e"
    lint_command: "make lint TARGET=e2e"
    # typecheck_command: 不适用于 E2E 测试（类型检查由 frontend/backend 栈处理）
    # docs 继承自 defaults.docs
    search_keywords:
      selector: ["selector", "locator", "element", "getBy", "findBy", "data-testid"]
      timing: ["timeout", "wait", "retry", "polling", "waitFor"]
      network: ["intercept", "mock", "request", "route", "fulfill"]
      assertion: ["expect", "assert", "toHave", "toBe", "toBeVisible"]
      navigation: ["goto", "navigate", "url", "redirect"]
    error_patterns:
      timeout_error:
        frequency: 35
        signals: ["Timeout.*exceeded", "waiting for", "locator", "30000ms"]
        description: "元素等待超时、操作超时"
      selector_error:
        frequency: 25
        signals: ["strict mode violation", "resolved to.*elements", "not found"]
        description: "选择器找不到元素、选择器不唯一"
      assertion_error:
        frequency: 15
        signals: ["expect.*toHave", "Expected", "Received", "AssertionError"]
        description: "断言失败、预期不匹配"
      network_error:
        frequency: 12
        signals: ["Route handler", "intercept", "net::ERR", "request failed"]
        description: "网络请求失败、API 拦截问题"
      navigation_error:
        frequency: 8
        signals: ["page.goto", "navigation", "ERR_NAME_NOT_RESOLVED"]
        description: "页面导航失败、URL 不匹配"
      environment_error:
        frequency: 3
        signals: ["browser.*launch", "context", "Target closed"]
        description: "浏览器启动失败、环境配置问题"

  pr_review:
    name: "PR Review Handler"

    # 置信度阈值
    # ┌─────────────────────────────────────────────────────────────────┐
    # │ 不变式 (INVARIANT): auto_fix > ask_user > need_clarification    │
    # │ 当前: 80 > 60 > 40 ✓                                           │
    # │                                                                  │
    # │ 阈值定义的是下界（含），决策逻辑：                               │
    # │   confidence >= 80 → auto_fix                                   │
    # │   confidence >= 60 → ask_user                                   │
    # │   confidence >= 40 → need_clarification                         │
    # │   confidence < 40  → skip (回复 reviewer)                       │
    # └─────────────────────────────────────────────────────────────────┘
    confidence_threshold:
      auto_fix: 80           # >= 80 高置信度，自动修复
      ask_user: 60           # 60-79 中置信度，询问用户后处理
      need_clarification: 40 # 40-59 低置信度，标记需澄清
      # < 40 极低置信度，跳过并回复 reviewer

    # 优先级定义 (batch_size: auto_fix=true 时为每批自动处理数，否则为每次展示给用户的数量)
    priority:
      P0:
        name: "blocker"
        description: "阻塞上线的安全/数据问题"
        auto_fix: true
        batch_size: 1
      P1:
        name: "critical"
        description: "核心功能缺陷"
        auto_fix: true
        batch_size: 3
      P2:
        name: "major"
        description: "重要改进"
        auto_fix: false
        batch_size: 5
      P3:
        name: "minor"
        description: "建议/风格问题"
        auto_fix: false
        batch_size: 10

    github:
      rate_limit_buffer: 10
      timeout_seconds: 30

    # 置信度评分因素权重
    # ┌─────────────────────────────────────────────────────────────────┐
    # │ 不变式 (INVARIANT): 所有权重之和必须等于 1.0                     │
    # │ 当前: 0.4 + 0.3 + 0.2 + 0.1 = 1.0 ✓                            │
    # │                                                                  │
    # │ 验证建议：使用此配置的 agent 应在启动时验证权重之和              │
    # │ sum([clarity, specificity, context, reproducibility]) == 1.0    │
    # │ 如果不等于 1.0，应发出警告并使用归一化后的权重                   │
    # └─────────────────────────────────────────────────────────────────┘
    confidence_factors:
      clarity: 0.4        # 评论明确性
      specificity: 0.3    # 具体示例
      context: 0.2        # 上下文理解
      reproducibility: 0.1 # 可复现性

    classification_keywords:
      security:
        patterns: ["security", "vulnerability", "injection", "XSS", "CSRF", "leak", "exposed", "sensitive"]
        priority_boost: 2
      critical:
        patterns: ["crash", "data loss", "downtime", "blocker", "production", "urgent"]
        priority: "P0"
      bug:
        patterns: ["bug", "broken", "fail", "error", "incorrect", "doesn't work", "not working"]
        priority: "P1"
      improvement:
        patterns: ["should", "better", "improve", "optimize", "refactor", "performance"]
        priority: "P2"
      suggestion:
        patterns: ["consider", "maybe", "could", "nit", "style", "minor", "typo"]
        priority: "P3"

    # 技术栈路径映射（可被项目配置覆盖）
    stack_path_patterns:
      backend:
        - "src/api/**"
        - "src/models/**"
        - "src/services/**"
        - "app/**"
        - "tests/backend/**"
        - "tests/unit/**"
        - "**/*.py"
      frontend:
        - "src/components/**"
        - "src/pages/**"
        - "src/hooks/**"
        - "src/stores/**"
        - "tests/frontend/**"
        - "**/*.tsx"
        - "**/*.jsx"
      e2e:
        - "tests/e2e/**"
        - "e2e/**"
        - "playwright/**"
        - "cypress/**"

    docs:
      review_reports_dir: "docs/reviews"
      # bugfix_dir, best_practices_dir 继承自 defaults.docs

    response_templates:
      fixed: |
        已修复

        感谢指出！已在 `{commit_sha}` 中完成修复。

        **变更**：
        - 文件：`{file}:{line}`
        - 修复详情：[Bugfix 文档]({doc_path})

        **测试**：
        {test_results}

      need_clarification: |
        需要更多信息

        感谢建议！为了更好地理解您的意图，能否提供更多细节？

        {questions}

      skipped_low_confidence: |
        暂不处理

        感谢建议！当前置信度较低（{confidence}%），原因：{reason}

        如果您认为这是重要问题，请提供：
        1. 具体的期望行为
        2. 复现步骤（如适用）

      outdated: |
        评论已过时

        此评论在最新代码提交之前创建，相关代码可能已更新。
        如果问题仍然存在，请更新评论或创建新评论。

      user_declined: |
        用户选择暂不处理

        感谢您的建议！PR 作者已确认此评论，但选择在当前迭代中暂不处理。

        原因：{reason}

        如果您认为这是必须修复的问题，请与 PR 作者进一步讨论。

      failed: |
        自动修复失败

        感谢指出！我们尝试自动修复此问题，但未能成功完成。

        **失败原因**：{error}
        **尝试次数**：{attempts}

        我们将人工处理此问题。如果您有更多建议，欢迎补充说明。

  ci_job:
    name: "CI Job Failure Handler"

    # 失败类型分类 (auto_fixable: "full"|"partial"|"none")
    failure_types:
      test_failure:
        signals: ["FAILED", "pytest", "jest", "vitest", "AssertionError", "test"]
        auto_fixable: "full"
        related_workflows: ["/fix-backend", "/fix-frontend", "/fix-e2e"]
      e2e_failure:
        signals: ["playwright", "cypress", "Timeout", "e2e", "puppeteer"]
        auto_fixable: "full"
        related_workflows: ["/fix-e2e"]
      build_failure:
        signals: ["tsc", "compile", "build failed", "webpack", "error TS"]
        auto_fixable: "partial"
        related_workflows: ["/fix-frontend", "/fix-backend"]
      lint_failure:
        signals: ["eslint", "ruff", "prettier", "lint", "@typescript-eslint"]
        auto_fixable: "full"
        # 使用 lint_quick_fix 映射中的工具特定命令，根据日志检测到的工具名称匹配
      type_check_failure:
        signals: ["type error", "mypy", "tsc --noEmit", "error TS"]
        auto_fixable: "partial"
        related_workflows: ["/fix-frontend", "/fix-backend"]
      dependency_failure:
        signals: ["npm install", "pip install", "yarn", "pnpm", "ERESOLVE", "requirement"]
        auto_fixable: "none"
      config_failure:
        signals: ["env", "secret", "permission denied", "credentials", "KEY_ERROR"]
        auto_fixable: "none"
      infrastructure_failure:
        signals: ["runner", "OOM", "killed", "disk space", "self-hosted"]
        auto_fixable: "none"

    # 置信度阈值
    # ┌─────────────────────────────────────────────────────────────────┐
    # │ 不变式 (INVARIANT): auto_fix > ask_user > suggest_manual        │
    # │ 当前: 80 > 60 > 40 ✓                                           │
    # │                                                                  │
    # │ 阈值定义的是下界（含），决策逻辑：                               │
    # │   confidence >= 80 → auto_fix                                   │
    # │   confidence >= 60 → ask_user                                   │
    # │   confidence >= 40 → suggest_manual                             │
    # │   confidence < 40  → skip                                       │
    # └─────────────────────────────────────────────────────────────────┘
    confidence_threshold:
      auto_fix: 80       # >= 80 自动修复
      ask_user: 60       # 60-79 询问用户
      suggest_manual: 40 # 40-59 建议手动
      # < 40 跳过，不处理

    # 置信度评分因素权重
    # ┌─────────────────────────────────────────────────────────────────┐
    # │ 不变式 (INVARIANT): 所有权重之和必须等于 1.0                     │
    # │ 当前: 0.4 + 0.3 + 0.2 + 0.1 = 1.0 ✓                            │
    # │                                                                  │
    # │ 验证建议：使用此配置的 agent 应在启动时验证权重之和              │
    # │ 如果不等于 1.0，应发出警告并使用归一化后的权重                   │
    # └─────────────────────────────────────────────────────────────────┘
    confidence_factors:
      signal_clarity: 0.4
      file_location: 0.3
      pattern_match: 0.2
      context_complete: 0.1

    github:
      log_max_lines: 5000
      timeout_seconds: 60
      log_retention_days: 90

    stack_detection:
      backend:
        patterns: ["pytest", "python", "FastAPI", "Django", "flask"]
        file_patterns: ["**/*.py", "tests/backend/**", "tests/unit/**"]
      frontend:
        patterns: ["jest", "vitest", "react", "vue", "angular", "typescript"]
        file_patterns: ["**/*.tsx", "**/*.jsx", "tests/frontend/**"]
      e2e:
        patterns: ["playwright", "cypress", "e2e", "puppeteer"]
        file_patterns: ["e2e/**", "tests/e2e/**", "playwright/**"]

    docs:
      ci_reports_dir: "docs/ci-reports"
      # bugfix_dir 继承自 defaults.docs

    # Lint 快速修复命令映射
    lint_quick_fix:
      eslint: "npx eslint --fix"
      ruff: "ruff check --fix"
      prettier: "npx prettier --write"
      biome: "npx biome check --apply"

  execute_plan:
    name: "Execute Plan Workflow"

    # 批次配置
    batch:
      default_size: 3           # 默认批次大小
      max_parallel: 2           # 最大并行任务数
      pause_between: true       # 批次间暂停确认

    # 置信度阈值
    # ┌─────────────────────────────────────────────────────────────────┐
    # │ 不变式 (INVARIANT): auto_execute > ask_user > suggest_manual    │
    # │ 当前: 80 > 60 > 40 ✓                                           │
    # │                                                                  │
    # │ 阈值定义的是下界（含），决策逻辑：                               │
    # │   confidence >= 80 → auto_execute                               │
    # │   confidence >= 60 → ask_user                                   │
    # │   confidence >= 40 → suggest_manual                             │
    # │   confidence < 40  → skip                                       │
    # └─────────────────────────────────────────────────────────────────┘
    confidence_threshold:
      auto_execute: 80          # >= 80 自动执行
      ask_user: 60              # 60-79 询问用户
      suggest_manual: 40        # 40-59 建议手动
      # < 40 跳过

    # 支持的计划格式
    plan_formats:
      - markdown
      - yaml

    # 任务检测模式
    task_detection:
      markdown_patterns:
        - "^## Task \\d+:"      # ## Task 1: xxx
        - "^### \\d+\\."        # ### 1. xxx
        - "^- \\[ \\]"          # - [ ] xxx (checklist)
        - "^\\d+\\. \\*\\*"     # 1. **xxx** (numbered bold)
      yaml_keys:
        - "tasks"
        - "steps"
        - "actions"

    # 文档配置
    docs:
      execution_reports_dir: "docs/execution-reports"
      # bugfix_dir, best_practices_dir 继承自 defaults.docs

    # Review 配置
    review:
      enabled: true
      max_fix_iterations: 3
      confidence_threshold: 80

    # 技术栈检测（用于选择合适的执行策略）
    stack_detection:
      backend:
        patterns: ["pytest", "python", "FastAPI", "Django", "flask"]
        file_patterns: ["**/*.py", "tests/backend/**", "tests/unit/**"]
      frontend:
        patterns: ["jest", "vitest", "react", "vue", "typescript"]
        file_patterns: ["**/*.tsx", "**/*.jsx", "tests/frontend/**"]
      e2e:
        patterns: ["playwright", "cypress", "e2e"]
        file_patterns: ["e2e/**", "tests/e2e/**", "playwright/**"]

  # 依赖管理配置（用于 merge-dep-prs 命令）
  dependency_management:
    name: "Dependency Management"

    # 技术栈依赖配置
    frontend:
      package_file: "frontend/package.json"
      lock_command: "cd frontend && pnpm install"
      keywords: ["package.json", "npm", "pnpm", "yarn", "node"]

    backend:
      package_file: "backend/pyproject.toml"
      lock_command: "cd backend && uv lock --no-cache"
      keywords: ["pyproject.toml", "requirements.txt", "pip", "uv", "poetry"]

    # Bot 配置
    bots:
      all:
        authors: ["app/renovate", "app/dependabot"]
      renovate:
        author: "app/renovate"
      dependabot:
        author: "app/dependabot"

    # 提交模板
    commit_message: "chore(deps): 合并依赖更新 ({date})"
    branch_prefix: "chore/merge-dependencies-"
