# Multi-stack bugfix workflow 默认配置
# 项目可通过 .claude/swiss-army-knife.yaml 覆盖

stacks:
  frontend:
    name: "Frontend (React/TypeScript)"
    test_command: "make test TARGET=frontend"
    lint_command: "make lint TARGET=frontend"
    typecheck_command: "make typecheck TARGET=frontend"
    docs:
      bugfix_dir: "docs/bugfix"
      best_practices_dir: "docs/best-practices"
      search_keywords:
        mock: ["mock", "msw", "vi.mock", "server.use", "HttpResponse"]
        async: ["async", "await", "findBy", "waitFor", "act"]
        type: ["typescript", "type", "interface", "as any", "generic"]
        render: ["render", "screen", "component", "props"]
        hook: ["useEffect", "useMemo", "useCallback", "useState"]
    error_patterns:
      mock_conflict:
        frequency: 71
        signals: ["vi.mock", "server.use"]
        description: "Mock 层次冲突（Hook Mock vs HTTP Mock）"
      type_mismatch:
        frequency: 15
        signals: ["as any", "type error", "Property.*does not exist"]
        description: "TypeScript 类型不匹配"
      async_timing:
        frequency: 8
        signals: ["findBy", "await", "act\\("]
        description: "异步操作时序问题"
      render_issue:
        frequency: 4
        signals: ["render", "screen", "not wrapped in act"]
        description: "组件渲染问题"
      cache_dependency:
        frequency: 2
        signals: ["useEffect", "useMemo", "dependency"]
        description: "Hook 缓存依赖问题"

  backend:
    name: "Backend (Python/FastAPI)"
    test_command: "make test TARGET=backend"
    lint_command: "make lint TARGET=backend"
    typecheck_command: "make typecheck TARGET=backend"
    docs:
      bugfix_dir: "docs/bugfix"
      best_practices_dir: "docs/best-practices"
      search_keywords:
        database: ["database", "query", "ORM", "SQL", "transaction", "SQLAlchemy"]
        api: ["endpoint", "request", "response", "REST", "GraphQL", "FastAPI"]
        auth: ["authentication", "authorization", "token", "JWT", "session"]
        validation: ["validation", "schema", "pydantic", "input", "sanitize"]
        async: ["async", "await", "asyncio", "concurrent"]
    error_patterns:
      database_error:
        frequency: 30
        signals: ["IntegrityError", "OperationalError", "sqlalchemy.exc", "UNIQUE constraint"]
        description: "数据库连接、查询、事务问题"
      validation_error:
        frequency: 25
        signals: ["ValidationError", "pydantic", "422 Unprocessable", "field required"]
        description: "输入验证、Schema 验证失败"
      api_error:
        frequency: 20
        signals: ["HTTPException", "status_code", "404 Not Found", "405 Method Not Allowed"]
        description: "API 端点错误、HTTP 状态码问题"
      auth_error:
        frequency: 10
        signals: ["401 Unauthorized", "403 Forbidden", "token", "credentials"]
        description: "认证授权失败、Token 问题"
      async_error:
        frequency: 8
        signals: ["TimeoutError", "CancelledError", "asyncio", "await"]
        description: "异步操作、并发问题"
      config_error:
        frequency: 5
        signals: ["KeyError", "environment", "settings", "config"]
        description: "配置加载、环境变量问题"

  e2e:
    name: "E2E (Playwright/Cypress)"
    test_command: "make test TARGET=e2e"
    lint_command: "make lint TARGET=e2e"
    docs:
      bugfix_dir: "docs/bugfix"
      best_practices_dir: "docs/best-practices"
      search_keywords:
        selector: ["selector", "locator", "element", "getBy", "findBy", "data-testid"]
        timing: ["timeout", "wait", "retry", "polling", "waitFor"]
        network: ["intercept", "mock", "request", "route", "fulfill"]
        assertion: ["expect", "assert", "toHave", "toBe", "toBeVisible"]
        navigation: ["goto", "navigate", "url", "redirect"]
    error_patterns:
      timeout_error:
        frequency: 35
        signals: ["Timeout.*exceeded", "waiting for", "locator", "30000ms"]
        description: "元素等待超时、操作超时"
      selector_error:
        frequency: 25
        signals: ["strict mode violation", "resolved to.*elements", "not found"]
        description: "选择器找不到元素、选择器不唯一"
      assertion_error:
        frequency: 15
        signals: ["expect.*toHave", "Expected", "Received", "AssertionError"]
        description: "断言失败、预期不匹配"
      network_error:
        frequency: 12
        signals: ["Route handler", "intercept", "net::ERR", "request failed"]
        description: "网络请求失败、API 拦截问题"
      navigation_error:
        frequency: 8
        signals: ["page.goto", "navigation", "ERR_NAME_NOT_RESOLVED"]
        description: "页面导航失败、URL 不匹配"
      environment_error:
        frequency: 3
        signals: ["browser.*launch", "context", "Target closed"]
        description: "浏览器启动失败、环境配置问题"

  pr_review:
    name: "PR Review Handler"

    # 置信度阈值
    # 置信度范围: 0-100，决定评论的处理方式
    confidence_threshold:
      auto_fix: 80            # >= 80 高置信度，自动修复
      ask_user: 60            # 60-79 中置信度，询问用户后处理
      need_clarification: 40  # 40-59 低置信度，标记需澄清
      skip: 40                # < 40 极低置信度，跳过并回复 reviewer

    # 优先级定义
    priority:
      P0:
        name: "blocker"
        description: "阻塞上线的安全/数据问题"
        auto_fix: true
        batch_size: 1   # 逐个处理
      P1:
        name: "critical"
        description: "核心功能缺陷"
        auto_fix: true
        batch_size: 3
      P2:
        name: "major"
        description: "重要改进"
        auto_fix: false  # 询问用户
        batch_size: 5
      P3:
        name: "minor"
        description: "建议/风格问题"
        auto_fix: false
        batch_size: 10

    # GitHub API 配置
    github:
      rate_limit_buffer: 10
      timeout_seconds: 30

    # 置信度评分因素权重
    confidence_factors:
      clarity: 0.4          # 评论明确性
      specificity: 0.3      # 具体示例
      context: 0.2          # 上下文理解
      reproducibility: 0.1  # 可复现性

    # 优先级分类关键词
    classification_keywords:
      security:
        patterns: ["security", "vulnerability", "injection", "XSS", "CSRF", "leak", "exposed", "sensitive"]
        priority_boost: 2
      critical:
        patterns: ["crash", "data loss", "downtime", "blocker", "production", "urgent"]
        priority: "P0"
      bug:
        patterns: ["bug", "broken", "fail", "error", "incorrect", "doesn't work", "not working"]
        priority: "P1"
      improvement:
        patterns: ["should", "better", "improve", "optimize", "refactor", "performance"]
        priority: "P2"
      suggestion:
        patterns: ["consider", "maybe", "could", "nit", "style", "minor", "typo"]
        priority: "P3"

    # 技术栈路径映射（可被项目配置覆盖）
    stack_path_patterns:
      backend:
        - "src/api/**"
        - "src/models/**"
        - "src/services/**"
        - "app/**"
        - "tests/backend/**"
        - "tests/unit/**"
        - "**/*.py"
      frontend:
        - "src/components/**"
        - "src/pages/**"
        - "src/hooks/**"
        - "src/stores/**"
        - "tests/frontend/**"
        - "**/*.tsx"
        - "**/*.jsx"
      e2e:
        - "tests/e2e/**"
        - "e2e/**"
        - "playwright/**"
        - "cypress/**"

    # 文档配置
    docs:
      bugfix_dir: "docs/bugfix"
      best_practices_dir: "docs/best-practices"
      review_reports_dir: "docs/reviews"

    # 回复模板
    response_templates:
      fixed: |
        ✅ 已修复

        感谢指出！已在 `{commit_sha}` 中完成修复。

        **变更**：
        - 文件：`{file}:{line}`
        - 修复详情：[Bugfix 文档]({doc_path})

        **测试**：
        {test_results}

      need_clarification: |
        ⏸️ 需要更多信息

        感谢建议！为了更好地理解您的意图，能否提供更多细节？

        {questions}

      skipped_low_confidence: |
        ❌ 暂不处理

        感谢建议！当前置信度较低（{confidence}%），原因：{reason}

        如果您认为这是重要问题，请提供：
        1. 具体的期望行为
        2. 复现步骤（如适用）

      outdated: |
        ℹ️ 评论已过时

        此评论在最新代码提交之前创建，相关代码可能已更新。
        如果问题仍然存在，请更新评论或创建新评论。

      user_declined: |
        ⏭️ 用户选择暂不处理

        感谢您的建议！PR 作者已确认此评论，但选择在当前迭代中暂不处理。

        原因：{reason}

        如果您认为这是必须修复的问题，请与 PR 作者进一步讨论。

      failed: |
        ❌ 自动修复失败

        感谢指出！我们尝试自动修复此问题，但未能成功完成。

        **失败原因**：{error}
        **尝试次数**：{attempts}

        我们将人工处理此问题。如果您有更多建议，欢迎补充说明。
