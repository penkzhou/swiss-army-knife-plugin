name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ## Review Instructions

            è¿™æ˜¯ä¸€ä¸ª Claude Code æ’ä»¶ä»“åº“çš„ PR reviewã€‚è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤è¿›è¡Œï¼š

            ### Step 1: è·å– PR diff å¹¶åˆ†æå˜æ›´ç±»å‹

            ä½¿ç”¨ `gh pr diff ${{ github.event.pull_request.number }}` è·å–å˜æ›´å†…å®¹ï¼Œç„¶ååˆ†ææ¶‰åŠçš„æ–‡ä»¶ç±»å‹ï¼š
            - **commands/** - æ–œæ å‘½ä»¤æ–‡ä»¶
            - **agents/** - Sub-agent å®šä¹‰æ–‡ä»¶
            - **skills/** - Skill çŸ¥è¯†åº“æ–‡ä»¶
            - **hooks/** - äº‹ä»¶é’©å­æ–‡ä»¶
            - **plugin.json** - æ’ä»¶æ¸…å•æ–‡ä»¶
            - **config/** - é…ç½®æ–‡ä»¶

            ### Step 2: æ ¹æ®å˜æ›´ç±»å‹è·å–å‚è€ƒæ–‡æ¡£

            æ ¹æ® diff æ¶‰åŠçš„æ–‡ä»¶ç±»å‹ï¼Œä½¿ç”¨ WebFetch å·¥å…·è·å–ç›¸åº”çš„å‚è€ƒæ–‡æ¡£ï¼š

            | å˜æ›´ç±»å‹ | å‚è€ƒæ–‡æ¡£ URL |
            |---------|-------------|
            | commands/ | https://code.claude.com/docs/en/slash-commands |
            | agents/ | https://code.claude.com/docs/en/sub-agents |
            | skills/ | https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices |
            | hooks/ | https://code.claude.com/docs/en/hooks |
            | plugin.json æˆ–æ•´ä½“æ¶æ„ | https://code.claude.com/docs/en/plugins |
            | API å­—æ®µå®šä¹‰é—®é¢˜ | https://code.claude.com/docs/en/plugins-reference |

            åªéœ€è·å–ä¸æœ¬æ¬¡å˜æ›´ç›¸å…³çš„æ–‡æ¡£ï¼Œä¸è¦è·å–æ‰€æœ‰æ–‡æ¡£ã€‚

            ### Step 3: è¿›è¡Œ Review

            åŸºäºè·å–çš„æ–‡æ¡£ï¼Œreview ä»¥ä¸‹æ–¹é¢ï¼š
            - **è§„èŒƒç¬¦åˆæ€§**ï¼šæ˜¯å¦ç¬¦åˆå®˜æ–¹æ–‡æ¡£å®šä¹‰çš„æ ¼å¼å’Œæœ€ä½³å®è·µ
            - **Frontmatter æ­£ç¡®æ€§**ï¼šYAML frontmatter å­—æ®µæ˜¯å¦æ­£ç¡®
            - **ä»£ç è´¨é‡**ï¼šé€»è¾‘æ¸…æ™°ã€æ— å†—ä½™ã€éµå¾ª DRY åŸåˆ™
            - **æ½œåœ¨é—®é¢˜**ï¼šå¯èƒ½çš„ bugã€è¾¹ç•Œæƒ…å†µã€é”™è¯¯å¤„ç†
            - **ä¸€è‡´æ€§**ï¼šä¸ä»“åº“ç°æœ‰ä»£ç é£æ ¼ä¿æŒä¸€è‡´

            åŒæ—¶å‚è€ƒä»“åº“çš„ CLAUDE.md äº†è§£é¡¹ç›®ç‰¹å®šçš„è§„èŒƒå’Œçº¦å®šã€‚

            ### Step 4: æäº¤ Review è¯„è®º

            ä½¿ç”¨ `gh pr comment ${{ github.event.pull_request.number }} --body "..."` æäº¤ä½ çš„ reviewã€‚

            è¯„è®ºæ ¼å¼å»ºè®®ï¼š
            ```
            ## ğŸ” Claude Code Review

            ### å˜æ›´æ¦‚è¿°
            [ç®€è¿°æœ¬æ¬¡ PR çš„ä¸»è¦å˜æ›´]

            ### âœ… ç¬¦åˆè§„èŒƒ
            [åˆ—å‡ºç¬¦åˆæœ€ä½³å®è·µçš„åœ°æ–¹]

            ### âš ï¸ å»ºè®®æ”¹è¿›
            [å…·ä½“çš„æ”¹è¿›å»ºè®®ï¼Œå¼•ç”¨å®˜æ–¹æ–‡æ¡£è¯´æ˜åŸå› ]

            ### ğŸ“š å‚è€ƒæ–‡æ¡£
            [åˆ—å‡ºæœ¬æ¬¡ review å‚è€ƒçš„æ–‡æ¡£é“¾æ¥]
            ```

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),WebFetch(code.claude.com:*),WebFetch(platform.claude.com:*)"'

